// ============================================================================
// MULTI-OSCILLATOR CONFLUENCE BUY SIGNAL INDICATOR + BB STATE MACHINE
// Pine Script v6
// ============================================================================
// State machine:
// 1) Arm when close < lower Bollinger Band
// 2) When price crosses back above lower band AND candle closes bullish AND close < basis,
//    then check confluence. If >= threshold AND mandatory conditions, print BUY.
// 3) Reset state after the trigger check (buy or no-buy), and also if price closes >= basis while armed.
// ============================================================================

//@version=6
import TradingView/ta/11 as TVta

indicator("Multi-Oscillator Confluence Signal (BB State)", shorttitle="Multi-Osc BB", overlay=false, max_labels_count=500)

// ============================================================================
// USER INPUTS
// ============================================================================

// --- Main Settings ---
bullishThreshold = input.float(67.0, "Bullish Threshold (%)", minval=50.0, maxval=100.0, step=1.0, group="Main Settings")
showTable        = input.bool(true, "Show Status Table", group="Main Settings")
tablePosition    = input.string("top_right", "Table Position",
     options=["top_right", "top_left", "bottom_right", "bottom_left"], group="Main Settings")

// --- RSI Settings ---
rsiLength     = input.int(10, "RSI Length", minval=2, maxval=50, group="RSI Settings")
rsiOversold   = input.float(30.0, "RSI Oversold Level", group="RSI Settings")
rsiOverbought = input.float(70.0, "RSI Overbought Level", group="RSI Settings")

// --- Laguerre RSI Settings ---
baseLagGamma       = input.float(0.30, "Base Laguerre Gamma (Alpha)", minval=0.01, maxval=0.99, step=0.01, group="Laguerre RSI")
useAdaptiveGamma   = input.bool(true, "Use Adaptive Gamma", group="Laguerre RSI")
gammaVolLookback   = input.int(10, "Adaptive Lookback (Vol)", minval=2, maxval=200, group="Laguerre RSI")
gammaVolSmooth     = input.int(50, "Adaptive Smooth (Vol)", minval=5, maxval=300, group="Laguerre RSI")
laguerreOversold   = input.float(20.0, "Laguerre Oversold Level", minval=0.0, maxval=50.0, group="Laguerre RSI")
laguerreOverbought = input.float(80.0, "Laguerre Overbought Level", minval=50.0, maxval=100.0, group="Laguerre RSI")

// --- Stochastic Settings ---
stochK      = input.int(14, "Stochastic %K Length", minval=1, group="Stochastic Settings")
stochD      = input.int(3, "Stochastic %D Smoothing", minval=1, group="Stochastic Settings")
stochSmooth = input.int(3, "Stochastic %K Smoothing", minval=1, group="Stochastic Settings")

// --- MACD Settings ---
macdFast   = input.int(12, "MACD Fast Length", minval=1, group="MACD Settings")
macdSlow   = input.int(26, "MACD Slow Length", minval=1, group="MACD Settings")
macdSignal = input.int(9, "MACD Signal Length", minval=1, group="MACD Settings")

// --- Aroon Settings ---
aroonLen = input.int(14, "Aroon Length", minval=1, group="Aroon Settings")

// --- Internal Bar Strength Settings ---
ibsThreshold = input.float(0.8, "IBS Threshold", minval=0.0, maxval=1.0, step=0.05, group="IBS Settings")

// --- EMA Settings (ema9 removed) ---
emaLen21  = input.int(21, "EMA 21", group="EMA Settings")
emaLen50  = input.int(50, "EMA 50", group="EMA Settings")
emaLen100 = input.int(100, "EMA 100", group="EMA Settings")
emaLen200 = input.int(200, "EMA 200", group="EMA Settings")
emaLen252 = input.int(252, "EMA 252", group="EMA Settings")

// --- Bollinger Bands Settings ---
bbLen  = input.int(20, "BB Length", minval=1, group="Bollinger Bands")
bbMult = input.float(2.0, "BB Mult", minval=0.1, step=0.1, group="Bollinger Bands")

// --- Visual Settings ---
buyLabelColor = input.color(color.green, "Buy Label Color", group="Visual Settings")
buyLabelStyle = input.string("Below Bar", "Buy Label Position", options=["Below Bar", "Above Bar"], group="Visual Settings")

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

clamp(v, lo, hi) =>
    math.max(lo, math.min(hi, v))

laguerreRSI(src, gamma) =>
    var float L0 = 0.0
    var float L1 = 0.0
    var float L2 = 0.0
    var float L3 = 0.0

    oneMinusGamma = 1.0 - gamma

    L0_new = gamma * src + oneMinusGamma * nz(L0[1])
    L1_new = -oneMinusGamma * L0_new + nz(L0[1]) + oneMinusGamma * nz(L1[1])
    L2_new = -oneMinusGamma * L1_new + nz(L1[1]) + oneMinusGamma * nz(L2[1])
    L3_new = -oneMinusGamma * L2_new + nz(L2[1]) + oneMinusGamma * nz(L3[1])

    L0 := L0_new
    L1 := L1_new
    L2 := L2_new
    L3 := L3_new

    cu = (L0 >= L1 ? L0 - L1 : 0.0) + (L1 >= L2 ? L1 - L2 : 0.0) + (L2 >= L3 ? L2 - L3 : 0.0)
    cd = (L0 <  L1 ? L1 - L0 : 0.0) + (L1 <  L2 ? L2 - L1 : 0.0) + (L2 <  L3 ? L3 - L2 : 0.0)

    denom = cu + cd
    denom != 0.0 ? 100.0 * cu / denom : 50.0

chandeMomentum(src, length) =>
    momUp   = math.max(src - src[1], 0.0)
    momDown = math.max(src[1] - src, 0.0)
    sumUp   = math.sum(momUp, length)
    sumDown = math.sum(momDown, length)
    denom   = sumUp + sumDown
    denom != 0.0 ? 100.0 * (sumUp - sumDown) / denom : 0.0

smi(src, kLength, d1Length, d2Length) =>
    ll = ta.lowest(low, kLength)
    hh = ta.highest(high, kLength)
    diff  = hh - ll
    rdiff = src - (hh + ll) / 2.0

    avgrel  = ta.ema(ta.ema(rdiff, d1Length), d2Length)
    avgdiff = ta.ema(ta.ema(diff,  d1Length), d2Length)

    avgdiff != 0.0 ? (avgrel / (avgdiff / 2.0)) * 100.0 : 0.0

ultimateOsc(fast, medium, slow) =>
    bp = close - math.min(low, close[1])
    tr = math.max(high, close[1]) - math.min(low, close[1])

    sumTrFast   = math.sum(tr, fast)
    sumTrMedium = math.sum(tr, medium)
    sumTrSlow   = math.sum(tr, slow)

    avgFast   = sumTrFast   != 0.0 ? math.sum(bp, fast)   / sumTrFast   : 0.0
    avgMedium = sumTrMedium != 0.0 ? math.sum(bp, medium) / sumTrMedium : 0.0
    avgSlow   = sumTrSlow   != 0.0 ? math.sum(bp, slow)   / sumTrSlow   : 0.0

    100.0 * (4.0 * avgFast + 2.0 * avgMedium + avgSlow) / 7.0

smiErgodic(src, fastLen, slowLen, signalLen) =>
    change_src = src - src[1]
    absChange  = math.abs(change_src)

    denom = ta.ema(ta.ema(absChange, fastLen), slowLen)
    tsi   = denom != 0.0 ? (ta.ema(ta.ema(change_src, fastLen), slowLen) / denom) * 100.0 : 0.0
    signal = ta.ema(tsi, signalLen)
    [tsi, signal]

pmo(src, firstSmooth, secondSmooth) =>
    roc = src[1] != 0.0 ? (src - src[1]) / src[1] * 100.0 : 0.0
    sm1 = ta.ema(roc, firstSmooth)
    sm2 = ta.ema(sm1 * 10.0, secondSmooth)
    sm2

dpo(src, length) =>
    shiftBack = math.floor(length / 2) + 1
    nz(src[shiftBack]) - ta.sma(src, length)

ppo(src, fastLen, slowLen, signalLen) =>
    fastEma = ta.ema(src, fastLen)
    slowEma = ta.ema(src, slowLen)
    ppoLine = slowEma != 0.0 ? (fastEma - slowEma) / slowEma * 100.0 : 0.0
    signalLine = ta.ema(ppoLine, signalLen)
    [ppoLine, signalLine]

getStatusColor(bool condition) =>
    condition ? color.green : color.red

getStatusText(bool condition) =>
    condition ? "BULLISH" : "BEARISH"

// ============================================================================
// BOLLINGER BANDS (PLOTTED ON MAIN CHART)
// ============================================================================

bbBasis = ta.sma(close, bbLen)
bbDev   = bbMult * ta.stdev(close, bbLen)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// Requested styling:
// Fill in Teal, upper/lower in Navy, middle in Orange
bbUpperPlot = plot(bbUpper, "BB Upper", color=color.navy, linewidth=1)
bbLowerPlot = plot(bbLower, "BB Lower", color=color.navy, linewidth=1)
plot(bbBasis, "BB Basis", color=color.orange, linewidth=1)
fill(bbUpperPlot, bbLowerPlot, color=color.teal, title="BB Fill")

// ============================================================================
// CALCULATIONS
// ============================================================================

// --- RSI ---
rsiValue   = ta.rsi(close, rsiLength)
rsiBullish = rsiValue < rsiOversold or (rsiValue > rsiValue[1] and rsiValue < 50)

// --- Adaptive Gamma (vol-based) ---
volNow   = ta.atr(gammaVolLookback)
volBase  = ta.sma(volNow, gammaVolSmooth)
volRatio = volBase != 0.0 ? volNow / volBase : 1.0
gammaAdaptive = clamp(baseLagGamma * volRatio, 0.01, 0.99)
gammaUsed     = useAdaptiveGamma ? gammaAdaptive : baseLagGamma

// --- Laguerre RSI (must be in zone and rising 2 bars) ---
laguerreValue   = laguerreRSI(close, gammaUsed)
laguerreInZone  = laguerreValue > laguerreOversold and laguerreValue < laguerreOverbought
laguerreRising2 = laguerreValue > laguerreValue[1] and laguerreValue[1] > laguerreValue[2]
laguerreBullish = laguerreInZone and laguerreRising2

// --- Stochastic ---
stochRaw    = ta.stoch(high, low, close, stochK)
stochKValue = ta.sma(stochRaw, stochSmooth)
stochDValue = ta.sma(stochKValue, stochD)
stochBullish = stochKValue < 20 or (stochKValue > stochDValue and stochKValue < 80)

// --- Stochastic RSI ---
stochRsiRaw = ta.stoch(rsiValue, rsiValue, rsiValue, 14)
stochRsiK   = ta.sma(stochRsiRaw, 3)
stochRsiD   = ta.sma(stochRsiK, 3)
stochRsiBullish = stochRsiK < 20 or (stochRsiK > stochRsiD and stochRsiK < 80)

// --- SMI ---
smiValue  = smi(close, 14, 3, 3)
smiSignal = ta.ema(smiValue, 9)
smiBullish = smiValue > smiSignal or smiValue < -40

// --- MACD ---
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdBullish = macdLine > signalLine or histLine > histLine[1]

// --- Klinger ---
sv = ta.change(hlc3) >= 0 ? volume : -volume
kvo = ta.ema(sv, 34) - ta.ema(sv, 55)
kvoSignal = ta.ema(kvo, 13)
kvoBullish = kvo > kvoSignal or kvo > kvo[1]

// --- Aroon (requested TVta) ---
[aroonUp, aroonDn] = TVta.aroon(aroonLen)
float aroonOsc = aroonUp - aroonDn
aroonBullish = aroonOsc > 0 or aroonOsc > aroonOsc[1]

// --- Awesome Oscillator ---
ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)
aoBullish = ao > 0 or ao > ao[1]

// --- Chaikin Oscillator ---
hlRange = high - low
mfm = hlRange != 0.0 ? ((close - low) - (high - close)) / hlRange : 0.0
adl = ta.cum(mfm * volume)
chaikinOsc = ta.ema(adl, 3) - ta.ema(adl, 10)
chaikinBullish = chaikinOsc > 0 or chaikinOsc > chaikinOsc[1]

// --- Ultimate Osc ---
uo = ultimateOsc(7, 14, 28)
uoBullish = uo < 30 or (uo > uo[1] and uo < 70)

// --- SMI Ergodic ---
[ergodicTSI, ergodicSignal] = smiErgodic(close, 5, 20, 5)
ergodicBullish = ergodicTSI > ergodicSignal or ergodicTSI > ergodicTSI[1]

// --- PMO ---
pmoValue  = pmo(close, 35, 20)
pmoSignal = ta.ema(pmoValue, 10)
pmoBullish = pmoValue > pmoSignal or pmoValue > pmoValue[1]

// --- CMO ---
cmo = chandeMomentum(close, 20)
cmoBullish = cmo > 0 or cmo > cmo[1]

// --- DPO ---
dpoValue = dpo(close, 20)
dpoBullish = dpoValue > 0 or dpoValue > dpoValue[1]

// --- PPO ---
[ppoLine, ppoSignalLine] = ppo(close, 12, 26, 9)
ppoBullish = ppoLine > ppoSignalLine or ppoLine > ppoLine[1]

// --- EMAs (ema9 removed) ---
ema21  = ta.ema(close, emaLen21)
ema50  = ta.ema(close, emaLen50)
ema100 = ta.ema(close, emaLen100)
ema200 = ta.ema(close, emaLen200)
ema252 = ta.ema(close, emaLen252)

ema21Bullish  = close > ema21
ema50Bullish  = close > ema50
ema100Bullish = close > ema100
ema200Bullish = close > ema200
ema252Bullish = close > ema252

// Plot EMAs
plot(ema21,  "EMA 21",  color=color.new(color.aqua,   55), linewidth=1, force_overlay = true)
plot(ema50,  "EMA 50",  color=color.new(color.orange, 55), linewidth=1, force_overlay = true)
plot(ema100, "EMA 100", color=color.new(color.purple, 60), linewidth=1, force_overlay = true)
plot(ema200, "EMA 200", color=color.new(color.gray,   60), linewidth=2, force_overlay = true)
plot(ema252, "EMA 252", color=color.new(color.fuchsia,60), linewidth=1, force_overlay = true)

// --- IBS ---
ibsRaw = (high - low) != 0.0 ? (close - low) / (high - low) : 0.5
ibs    = clamp(ibsRaw, 0.0, 1.0)
ibsBullish = ibs > ibsThreshold

// ============================================================================
// SCORE
// ============================================================================

// Total indicators:
// 16 oscillators + IBS (1) + 5 EMAs = 22
totalIndicators = 22

bullishCount = 0
bullishCount += rsiBullish ? 1 : 0
bullishCount += laguerreBullish ? 1 : 0
bullishCount += stochBullish ? 1 : 0
bullishCount += stochRsiBullish ? 1 : 0
bullishCount += smiBullish ? 1 : 0
bullishCount += macdBullish ? 1 : 0
bullishCount += kvoBullish ? 1 : 0
bullishCount += aroonBullish ? 1 : 0
bullishCount += aoBullish ? 1 : 0
bullishCount += chaikinBullish ? 1 : 0
bullishCount += uoBullish ? 1 : 0
bullishCount += ergodicBullish ? 1 : 0
bullishCount += pmoBullish ? 1 : 0
bullishCount += cmoBullish ? 1 : 0
bullishCount += dpoBullish ? 1 : 0
bullishCount += ppoBullish ? 1 : 0
bullishCount += ibsBullish ? 1 : 0
bullishCount += ema21Bullish ? 1 : 0
bullishCount += ema50Bullish ? 1 : 0
bullishCount += ema100Bullish ? 1 : 0
bullishCount += ema200Bullish ? 1 : 0
bullishCount += ema252Bullish ? 1 : 0

bullishPercent = (bullishCount / totalIndicators) * 100.0

// Hidden plot so alerts can use {{plot_0}} as bullishPercent
plot(bullishPercent, "Bullish % (hidden)", display=display.none)

// Laguerre RSI in pane
// --- Laguerre RSI Plot (in oscillator pane - this is the default pane since overlay=false) ---
// Color coding: Green = Bullish (above oversold), Red = Bearish (below oversold or above overbought)
laguerreColor = laguerreBullish ? color.green : color.red
plot(laguerreValue, "Laguerre RSI", color=laguerreColor, linewidth=2)

// Horizontal reference lines for Laguerre RSI levels
hline(laguerreOversold, "Oversold", color=color.new(color.red, 50), linestyle=hline.style_dashed, linewidth=1)
hline(laguerreOverbought, "Overbought", color=color.new(color.red, 50), linestyle=hline.style_dashed, linewidth=1)
hline(50, "Midline", color=color.new(color.gray, 70), linestyle=hline.style_dotted, linewidth=1)

// Fill background between oversold and overbought to highlight the "healthy zone"
h_oversold = hline(laguerreOversold, color=color.new(color.green, 100))
h_overbought = hline(laguerreOverbought, color=color.new(color.green, 100))
fill(h_oversold, h_overbought, color=color.new(color.green, 90), title="Bullish Zone")

// ============================================================================
// BB STATE MACHINE + BUY LOGIC
// ============================================================================

var int bbState = 0  // 0 = idle, 1 = armed

isBullCandle = close > open

// 1) Arm when price closes below lower BB (at close)
if barstate.isconfirmed and bbState == 0 and close < bbLower
    bbState := 1

// Reset if armed and price closes back above/at basis without triggering the re-entry logic
if barstate.isconfirmed and bbState == 1 and close >= bbBasis
    bbState := 0

// 2) Trigger check when crossing back above lower band + bullish close + still below basis
reEntryTrigger = barstate.isconfirmed and bbState == 1 and ta.crossover(close, bbLower) and isBullCandle and close < bbBasis

// Confluence check happens ONLY on the trigger bar
confluenceOk = bullishPercent >= bullishThreshold and laguerreBullish and ibsBullish

buyCondition = reEntryTrigger and confluenceOk

// 3) Reset state machine after trigger check (buy OR no-buy)
if reEntryTrigger
    bbState := 0

// Buy label
labelStyle = buyLabelStyle == "Below Bar" ? label.style_label_up : label.style_label_down
if buyCondition
    label.new(
         bar_index,
         buyLabelStyle == "Below Bar" ? low : high,
         "BUY\n" + str.tostring(bullishPercent, "#.0") + "%",
         color=buyLabelColor,
         textcolor=color.white,
         style=labelStyle,
         size=size.small
     )

// Optional background highlight on buy
bgcolor(buyCondition ? color.new(color.green, 85) : na)

// ============================================================================
// STATUS TABLE
// ============================================================================

tablePos = switch tablePosition
    "top_right"    => position.top_right
    "top_left"     => position.top_left
    "bottom_right" => position.bottom_right
    "bottom_left"  => position.bottom_left
    => position.top_right

// Rows: header(1) + summary(1) + 22 indicators + footer(1) = 25
var table statusTable = table.new(tablePos, 4, 25, bgcolor=color.new(color.black, 20), border_color=color.gray, border_width=1, force_overlay = true)

if showTable and barstate.islast
    // Header
    table.cell(statusTable, 0, 0, "INDICATOR", bgcolor=color.new(color.blue, 50), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, 0, "VALUE",     bgcolor=color.new(color.blue, 50), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, 0, "STATUS",    bgcolor=color.new(color.blue, 50), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, 0, "SIGNAL",    bgcolor=color.new(color.blue, 50), text_color=color.white, text_size=size.tiny)

    // Summary
    summaryColor = bullishPercent >= bullishThreshold ? color.green : color.orange
    table.cell(statusTable, 0, 1, "OVERALL", bgcolor=color.new(summaryColor, 70), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, 1, str.tostring(bullishCount) + "/" + str.tostring(totalIndicators), bgcolor=color.new(summaryColor, 70), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, 1, str.tostring(bullishPercent, "#.1") + "%", bgcolor=color.new(summaryColor, 70), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, 1, buyCondition ? "BUY" : (bbState == 1 ? "ARMED" : "WAIT"),
        bgcolor=color.new(buyCondition ? color.green : (bbState == 1 ? color.orange : color.gray), 70),
        text_color=color.white, text_size=size.tiny)

    row = 2

    // RSI
    table.cell(statusTable, 0, row, "RSI (" + str.tostring(rsiLength) + ")", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(rsiValue, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(rsiBullish), bgcolor=getStatusColor(rsiBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, rsiBullish ? "✓" : "✗", bgcolor=getStatusColor(rsiBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Laguerre (MANDATORY) + Rising2
    lagTxt = (laguerreInZone ? "IN-ZONE" : "OUT-ZONE") + (laguerreRising2 ? " +R2" : " -R2")
    table.cell(statusTable, 0, row, "LAGUERRE RSI*", text_color=color.yellow, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(laguerreValue, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, lagTxt, bgcolor=getStatusColor(laguerreBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, laguerreBullish ? "✓" : "✗", bgcolor=getStatusColor(laguerreBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // IBS (MANDATORY)
    table.cell(statusTable, 0, row, "IBS*", text_color=color.yellow, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ibs, "#.3"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ibs > ibsThreshold ? "> " + str.tostring(ibsThreshold, "#.1") : "<= " + str.tostring(ibsThreshold, "#.1"),
        bgcolor=getStatusColor(ibsBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ibsBullish ? "✓" : "✗", bgcolor=getStatusColor(ibsBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Stoch
    table.cell(statusTable, 0, row, "Stochastic", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(stochKValue, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(stochBullish), bgcolor=getStatusColor(stochBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, stochBullish ? "✓" : "✗", bgcolor=getStatusColor(stochBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Stoch RSI
    table.cell(statusTable, 0, row, "Stoch RSI", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(stochRsiK, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(stochRsiBullish), bgcolor=getStatusColor(stochRsiBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, stochRsiBullish ? "✓" : "✗", bgcolor=getStatusColor(stochRsiBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // SMI
    table.cell(statusTable, 0, row, "SMI", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(smiValue, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(smiBullish), bgcolor=getStatusColor(smiBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, smiBullish ? "✓" : "✗", bgcolor=getStatusColor(smiBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // MACD
    table.cell(statusTable, 0, row, "MACD", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(macdLine, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(macdBullish), bgcolor=getStatusColor(macdBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, macdBullish ? "✓" : "✗", bgcolor=getStatusColor(macdBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Klinger
    table.cell(statusTable, 0, row, "Klinger", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(kvo, "#.0"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(kvoBullish), bgcolor=getStatusColor(kvoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, kvoBullish ? "✓" : "✗", bgcolor=getStatusColor(kvoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Aroon
    table.cell(statusTable, 0, row, "Aroon (" + str.tostring(aroonLen) + ")", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(aroonOsc, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(aroonBullish), bgcolor=getStatusColor(aroonBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, aroonBullish ? "✓" : "✗", bgcolor=getStatusColor(aroonBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // AO
    table.cell(statusTable, 0, row, "Awesome Osc", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ao, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(aoBullish), bgcolor=getStatusColor(aoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, aoBullish ? "✓" : "✗", bgcolor=getStatusColor(aoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Chaikin
    table.cell(statusTable, 0, row, "Chaikin", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(chaikinOsc, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(chaikinBullish), bgcolor=getStatusColor(chaikinBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, chaikinBullish ? "✓" : "✗", bgcolor=getStatusColor(chaikinBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // UO
    table.cell(statusTable, 0, row, "Ultimate Osc", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(uo, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(uoBullish), bgcolor=getStatusColor(uoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, uoBullish ? "✓" : "✗", bgcolor=getStatusColor(uoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Ergodic
    table.cell(statusTable, 0, row, "SMI Ergodic", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ergodicTSI, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(ergodicBullish), bgcolor=getStatusColor(ergodicBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ergodicBullish ? "✓" : "✗", bgcolor=getStatusColor(ergodicBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // PMO
    table.cell(statusTable, 0, row, "PMO", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(pmoValue, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(pmoBullish), bgcolor=getStatusColor(pmoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, pmoBullish ? "✓" : "✗", bgcolor=getStatusColor(pmoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // CMO
    table.cell(statusTable, 0, row, "Chande Mom", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(cmo, "#.1"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(cmoBullish), bgcolor=getStatusColor(cmoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, cmoBullish ? "✓" : "✗", bgcolor=getStatusColor(cmoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // DPO
    table.cell(statusTable, 0, row, "Detrended PO", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(dpoValue, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(dpoBullish), bgcolor=getStatusColor(dpoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, dpoBullish ? "✓" : "✗", bgcolor=getStatusColor(dpoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // PPO
    table.cell(statusTable, 0, row, "PPO", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ppoLine, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, getStatusText(ppoBullish), bgcolor=getStatusColor(ppoBullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ppoBullish ? "✓" : "✗", bgcolor=getStatusColor(ppoBullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // EMA 21/50/100/200/252
    table.cell(statusTable, 0, row, "EMA 21", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ema21, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ema21Bullish ? "ABOVE" : "BELOW", bgcolor=getStatusColor(ema21Bullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ema21Bullish ? "✓" : "✗", bgcolor=getStatusColor(ema21Bullish), text_color=color.white, text_size=size.tiny)
    row += 1

    table.cell(statusTable, 0, row, "EMA 50", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ema50, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ema50Bullish ? "ABOVE" : "BELOW", bgcolor=getStatusColor(ema50Bullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ema50Bullish ? "✓" : "✗", bgcolor=getStatusColor(ema50Bullish), text_color=color.white, text_size=size.tiny)
    row += 1

    table.cell(statusTable, 0, row, "EMA 100", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ema100, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ema100Bullish ? "ABOVE" : "BELOW", bgcolor=getStatusColor(ema100Bullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ema100Bullish ? "✓" : "✗", bgcolor=getStatusColor(ema100Bullish), text_color=color.white, text_size=size.tiny)
    row += 1

    table.cell(statusTable, 0, row, "EMA 200", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ema200, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ema200Bullish ? "ABOVE" : "BELOW", bgcolor=getStatusColor(ema200Bullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ema200Bullish ? "✓" : "✗", bgcolor=getStatusColor(ema200Bullish), text_color=color.white, text_size=size.tiny)
    row += 1

    table.cell(statusTable, 0, row, "EMA 252", text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 1, row, str.tostring(ema252, "#.2"), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 2, row, ema252Bullish ? "ABOVE" : "BELOW", bgcolor=getStatusColor(ema252Bullish), text_color=color.white, text_size=size.tiny)
    table.cell(statusTable, 3, row, ema252Bullish ? "✓" : "✗", bgcolor=getStatusColor(ema252Bullish), text_color=color.white, text_size=size.tiny)
    row += 1

    // Footer (row index 24)
    table.cell(statusTable, 0, 24, "* MANDATORY", bgcolor=color.new(color.yellow, 70), text_color=color.black, text_size=size.tiny)
    table.cell(statusTable, 1, 24, "", bgcolor=color.new(color.yellow, 70), text_size=size.tiny)
    table.cell(statusTable, 2, 24, "", bgcolor=color.new(color.yellow, 70), text_size=size.tiny)
    table.cell(statusTable, 3, 24, "", bgcolor=color.new(color.yellow, 70), text_size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buyCondition, title="BB State Buy Signal",
     message="BUY SIGNAL: {{ticker}} at {{close}}. Bullish: {{plot_0}}%")

approachingBuy = (bbState == 1) and bullishPercent >= (bullishThreshold - 5) and bullishPercent < bullishThreshold and laguerreBullish and ibsBullish
alertcondition(approachingBuy, title="BB State Approaching Threshold",
     message="ARMED + APPROACHING: {{ticker}} at {{close}}. Bullish: {{plot_0}}%")
